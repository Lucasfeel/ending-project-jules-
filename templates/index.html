<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹íˆ° ì™„ê²° ì•Œë¦¬ë¯¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: 'Pretendard', 'Noto Sans KR', sans-serif; background-color: #121212; color: #e0e0e0; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { color: #ffffff; background-color: #4f46e5; }
        .webtoon-row { border-bottom: 1px solid #2d2d2d; transition: background-color 0.2s ease; }
        .webtoon-row:hover { background-color: #1e1e1e; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: #2a2a2a; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased pb-24">

    <header class="bg-[#121212]/95 backdrop-blur-lg py-4 px-4 sticky top-0 z-30 border-b border-[#2d2d2d]">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" id="homeButton" class="flex items-center gap-1 cursor-pointer">
                <h1 class="text-2xl font-black text-white tracking-tighter">EN<span class="text-yellow-400">ğŸ””</span></h1>
            </a>
            <button id="searchButton" class="p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-100"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
        </div>
    </header>

    <main class="container mx-auto p-4">
        <!-- L1 Provider Filter & L2 Detail Tabs will be rendered here by JS -->
        <div id="filterContainer" class="sticky top-[73px] bg-[#121212] z-20 py-2">
            <div id="sourceSelectorContainer" class="mb-4"></div>
            <div id="tabContainer" class="overflow-x-auto"></div>
        </div>

        <!-- Content Grid -->
        <div id="contentGridContainer" class="mt-4"></div>

        <div id="paginationContainer" class="text-center py-8"></div>
        <div id="statusIndicator" class="text-center py-20"></div>
    </main>

    <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 bg-[#121212]/95 backdrop-blur border-t border-[#2d2d2d] z-30">
        <div class="container mx-auto flex justify-around">
            <!-- Tabs will be rendered here by JS -->
        </div>
    </nav>

    <div id="subscribeModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 modal-backdrop"></div>
        <div id="modalContent" class="relative z-10 modal-content p-8 rounded-xl w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0">
            <h2 class="text-2xl font-bold mb-2 text-white">ì™„ê²° ì•Œë¦¼ ë°›ê¸°</h2>
            <p id="modalWebtoonTitle" class="mb-4 text-gray-400"></p>
            <div id="modalWebtoonLinkContainer" class="mb-6"></div>
            <div class="mb-4">
                <input type="email" id="emailInput" placeholder="ì•Œë¦¼ë°›ì„ ì´ë©”ì¼ ì£¼ì†Œ" class="w-full p-3 rounded-md bg-[#3a3a3c] border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
                <p id="emailError" class="text-red-400 text-sm mt-1 h-5"></p>
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelButton" class="px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-500 text-white font-semibold transition-colors">ì·¨ì†Œ</button>
                <button id="subscribeButton" class="px-6 py-2 rounded-md bg-indigo-600 hover:bg-indigo-500 text-white font-semibold transition-colors">êµ¬ë…í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 px-6 py-3 rounded-lg shadow-xl text-white transform translate-y-20 opacity-0 transition-all duration-500 ease-in-out"></div>

    <script>
    {% raw %}
        document.addEventListener('DOMContentLoaded', () => {
            const UI = {
                bottomNav: document.getElementById('bottomNav').querySelector('.container'),
                contentGridContainer: document.getElementById('contentGridContainer'),
                tabContainer: document.getElementById('tabContainer'),
                sourceSelectorContainer: document.getElementById('sourceSelectorContainer'),
                paginationContainer: document.getElementById('paginationContainer'),
                statusIndicator: document.getElementById('statusIndicator'),
                homeButton: document.getElementById('homeButton'),
                searchButton: document.getElementById('searchButton'),
                modal: document.getElementById('subscribeModal'),
                modalContent: document.getElementById('modalContent'),
                modalWebtoonTitle: document.getElementById('modalWebtoonTitle'),
                modalWebtoonLinkContainer: document.getElementById('modalWebtoonLinkContainer'),
                emailInput: document.getElementById('emailInput'),
                emailError: document.getElementById('emailError'),
                subscribeButton: document.getElementById('subscribeButton'),
                cancelButton: document.getElementById('cancelButton'),
                toast: document.getElementById('toast'),
            };

            const TABS_CONFIG = {
                webtoon: { mon: 'ì›”', tue: 'í™”', wed: 'ìˆ˜', thu: 'ëª©', fri: 'ê¸ˆ', sat: 'í† ', sun: 'ì¼', daily: 'ë§¤ì¼+', hiatus: 'íœ´ì¬', completed: 'ì™„ê²°' },
                novel: { latest: 'ìµœì‹ ', popular: 'ì¸ê¸°', completed: 'ì™„ê²°' },
                ott: { action: 'ì•¡ì…˜', romance: 'ë¡œë§¨ìŠ¤', drama: 'ë“œë¼ë§ˆ' },
                series: { latest: 'ìµœì‹ ìˆœ', alphabetical: 'ê°€ë‚˜ë‹¤ìˆœ' },
                my: { subscribing: 'êµ¬ë…ì¤‘', completed: 'ì™„ê²°ë¨' }
            };

            const state = {
                theme: 'dark',
                activeTab: 'webtoon',
                filters: {
                    webtoon: { source: 'all', day: 'mon' },
                    novel: { source: 'all', type: 'latest' },
                    ott: { source: 'all', genre: 'action' },
                    series: { sort: 'latest' },
                    my: { viewMode: 'subscribing' }
                },
                contents: {
                    webtoon: {},
                    novel: {},
                    ott: {},
                    series: {},
                    my: {}
                },
                mySubscriptions: [], // Example: [{ content_id: '123', source: 'naver_webtoon' }]
                isLoading: false,
                currentModal: { contentId: null, source: null }
            };

            // --- Core Logic ---

            async function updateContent(forceRefresh = false) {
                state.isLoading = true;
                renderUI();

                const { activeTab } = state;
                const currentFilters = state.filters[activeTab];

                // For now, only the webtoon tab fetches real data.
                if (activeTab === 'webtoon') {
                    try {
                        const { source, day } = currentFilters;
                        const endpoint = (day === 'hiatus' || day === 'completed') ? day : 'ongoing';
                        const cacheKey = `${source}_${day}`;

                        if (!state.contents.webtoon[cacheKey] || forceRefresh) {
                            const sourceParam = source !== 'all' ? `&source=${source}` : '';
                            const response = await fetch(`/api/contents/${endpoint}?type=webtoon${sourceParam}`);
                            if (!response.ok) throw new Error('Network response was not ok');
                            state.contents.webtoon[cacheKey] = await response.json();
                        }
                    } catch (error) {
                        console.error("Failed to fetch webtoon data:", error);
                        UI.statusIndicator.innerHTML = '<p class="text-red-400">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                    }
                }

                state.isLoading = false;
                renderUI();
            }

            // --- UI Rendering ---

            function renderUI() {
                renderBottomNav();
                renderFilters();
                renderContentGrid();

                if (state.isLoading) {
                    UI.statusIndicator.innerHTML = '<div class="loader"></div>';
                    UI.contentGridContainer.innerHTML = '';
                } else {
                    UI.statusIndicator.innerHTML = '';
                }
            }

            function renderBottomNav() {
                UI.bottomNav.innerHTML = '';
                Object.keys(TABS_CONFIG).forEach(tabId => {
                    const button = document.createElement('button');
                    const isActive = state.activeTab === tabId;
                    button.className = `flex flex-col items-center justify-center py-2 px-1 w-full text-center transition-colors duration-200 ${isActive ? 'text-indigo-400' : 'text-gray-400 hover:text-white'}`;
                    button.innerHTML = `<span class="text-xs font-bold">${{webtoon:'ì›¹íˆ°', novel:'ì›¹ì†Œì„¤', ott:'OTT', series:'ì‹œë¦¬ì¦ˆ', my:'ë‚˜ì˜ êµ¬ë…'}[tabId]}</span>`;
                    button.onclick = () => {
                        state.activeTab = tabId;
                        updateContent();
                    };
                    UI.bottomNav.appendChild(button);
                });
            }

            function renderFilters() {
                const { activeTab } = state;
                UI.sourceSelectorContainer.innerHTML = '';
                UI.tabContainer.innerHTML = '';
                UI.paginationContainer.innerHTML = '';

                if (activeTab === 'webtoon' || activeTab === 'novel' || activeTab === 'ott') {
                    renderSourceSelector(activeTab);
                }
                if (TABS_CONFIG[activeTab]) {
                    renderDetailTabs(activeTab);
                }
                if (activeTab === 'series') {
                    renderSeriesFooterButton();
                }
            }

            function renderSourceSelector(tabId) {
                const sources = {
                    'all': { name: 'ì „ì²´', logo: 'https://via.placeholder.com/40' },
                    'naver_webtoon': { name: 'ë„¤ì´ë²„ì›¹íˆ°', logo: 'https://via.placeholder.com/40/03C75A?text=N' },
                    'kakaowebtoon': { name: 'ì¹´ì¹´ì˜¤ì›¹íˆ°', logo: 'https://via.placeholder.com/40/FFCD00?text=K' }
                };
                const sourceList = document.createElement('div');
                sourceList.className = 'flex items-center gap-4 overflow-x-auto pb-2';

                Object.entries(sources).forEach(([key, value]) => {
                    const button = document.createElement('button');
                    const isActive = state.filters[tabId].source === key;
                    button.className = `flex-shrink-0 w-12 h-12 rounded-full overflow-hidden transition-all duration-200 ${isActive ? 'ring-2 ring-indigo-500 ring-offset-2 ring-offset-black' : 'opacity-60 hover:opacity-100'}`;
                    button.innerHTML = `<img src="${value.logo}" alt="${value.name}" class="w-full h-full object-cover">`;
                    button.onclick = () => {
                        state.filters[tabId].source = key;
                        updateContent(true);
                    };
                    sourceList.appendChild(button);
                });
                UI.sourceSelectorContainer.appendChild(sourceList);
            }

            function renderDetailTabs(tabId) {
                const detailTabs = TABS_CONFIG[tabId];
                const activeDetailTab = state.filters[tabId].day || state.filters[tabId].type || state.filters[tabId].genre || state.filters[tabId].sort || state.filters[tabId].viewMode;

                const tabList = document.createElement('div');
                tabList.className = 'flex space-x-2 border-b border-gray-700';

                Object.entries(detailTabs).forEach(([key, value]) => {
                    const button = document.createElement('button');
                    const isActive = activeDetailTab === key;
                    button.className = `tab-button px-4 py-2 text-sm font-bold rounded-t-lg whitespace-nowrap ${isActive ? 'text-white border-b-2 border-indigo-500' : 'text-gray-400 hover:text-white'}`;
                    button.textContent = value;
                    button.onclick = () => {
                        if (tabId === 'webtoon') state.filters.webtoon.day = key;
                        // Add other tab filter updates here
                        updateContent();
                    };
                    tabList.appendChild(button);
                });
                UI.tabContainer.appendChild(tabList);
            }

            function renderContentGrid() {
                UI.contentGridContainer.innerHTML = '';
                if (state.isLoading) return;

                const { activeTab } = state;
                let dataToRender = [];

                if (activeTab === 'webtoon') {
                    const { source, day } = state.filters.webtoon;
                    const cacheKey = `${source}_${day}`;
                    const webtoonData = state.contents.webtoon[cacheKey];

                    if (day === 'hiatus' || day === 'completed') {
                        dataToRender = webtoonData?.contents || [];
                    } else {
                        dataToRender = webtoonData?.[day] || [];
                    }
                } else {
                    UI.contentGridContainer.innerHTML = `<p class="text-center text-gray-500 py-10">${TABS_CONFIG[activeTab] ? Object.values(TABS_CONFIG[activeTab])[0] : ''} íƒ­ì€ í˜„ì¬ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>`;
                    return;
                }

                if (dataToRender.length === 0) {
                    UI.contentGridContainer.innerHTML = '<p class="text-center text-gray-500 py-10">í‘œì‹œí•  ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                UI.contentGridContainer.className = 'grid grid-cols-3 gap-4';
                dataToRender.forEach(content => {
                    UI.contentGridContainer.appendChild(createContentCard(content));
                });
            }

            function renderSeriesFooterButton() {
                UI.paginationContainer.innerHTML = '';
                if (state.activeTab !== 'series') return;

                const button = document.createElement('button');
                button.className = 'w-full bg-gray-800 text-gray-400 font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors';
                button.textContent = '(+) ë‹¹ì‹ ì˜ ì‹œë¦¬ì¦ˆë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”';
                button.onclick = () => window.open('https://forms.gle/HHhRRxZdE8g4x6nm9', '_blank');
                UI.paginationContainer.appendChild(button);
            }

            function createContentCard(content) {
                const card = document.createElement('div');
                card.className = 'content-card bg-[#1e1e1e] rounded-lg overflow-hidden cursor-pointer transform hover:-translate-y-1 transition-transform duration-200 relative';

                const thumbnailUrl = content.meta?.common?.thumbnail_url || 'https://via.placeholder.com/400x300?text=No+Image';
                const authorsText = content.meta?.common?.authors?.join(', ') || 'ì‘ê°€ ì •ë³´ ì—†ìŒ';

                let badge = '';
                if (content.status === 'ì™„ê²°') {
                    badge = '<span class="absolute top-2 left-2 text-xs font-bold bg-green-600 text-white px-2 py-1 rounded-full">ì™„ê²°</span>';
                } else if (content.status === 'íœ´ì¬') {
                    badge = '<span class="absolute top-2 left-2 text-xs font-bold bg-gray-600 text-white px-2 py-1 rounded-full">íœ´ì¬</span>';
                }

                card.innerHTML = `
                    <div class="aspect-[4/3] bg-gray-700 bg-cover bg-center" style="background-image: url('${thumbnailUrl}')">
                        ${badge}
                    </div>
                    <div class="p-2">
                        <p class="font-bold text-white truncate text-sm">${content.title}</p>
                        <p class="text-xs text-gray-400 truncate mt-1">${authorsText}</p>
                    </div>
                `;
                card.onclick = () => openModal(content.content_id, content.title, content.source);
                return card;
            }

            // --- Event Handlers & Initialization ---

            function openModal(contentId, titleText, source) {
                state.currentModal = { contentId, source };
                UI.modalWebtoonTitle.textContent = `'${titleText}'`;

                let webtoonLink = '#';
                if (source === 'naver_webtoon') {
                    webtoonLink = `https://comic.naver.com/webtoon/list?titleId=${contentId}`;
                } else if (source === 'kakaowebtoon') {
                    webtoonLink = `https://webtoon.kakao.com/content/${titleText}/${contentId.split('-').pop()}`;
                }
                UI.modalWebtoonLinkContainer.innerHTML = `<a href="${webtoonLink}" target="_blank" class="text-indigo-400 hover:text-indigo-300">ì›¹íˆ° ë°”ë¡œê°€ê¸° &rarr;</a>`;

                UI.modal.classList.remove('hidden');
                setTimeout(() => UI.modalContent.classList.remove('scale-95', 'opacity-0'), 10);
            }

            function closeModal() {
                UI.modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    UI.modal.classList.add('hidden');
                    UI.emailError.textContent = '';
                }, 300);
            }

            async function handleSubscription() {
                // Subscription logic remains largely the same, using state.currentModal
            }

            function showToast(message, type = 'success') {
                // Toast logic remains the same
            }

            function initialize() {
                updateContent(); // Initial data fetch and render

                UI.homeButton.onclick = (e) => { e.preventDefault(); window.location.reload(); };
                // Add other global event listeners like search, modal buttons etc. here
                UI.cancelButton.onclick = closeModal;
                UI.subscribeButton.onclick = handleSubscription;
                UI.modal.onclick = (e) => { if (e.target === UI.modal) closeModal(); };
            }

            initialize();
        });
    {% endraw %}
    </script>
</body>
</html>